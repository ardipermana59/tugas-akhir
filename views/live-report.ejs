<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css">
  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css">
  <script src="/socket.io/socket.io.js"></script>
</head>

<body>
  <div class="container-fluid">
    <div class="row pt-2 mb-3">
      <div class="col-md-4 offset-4">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Perolehan Suara Sementara</h3>
          </div>
          <!-- /.card-header -->
          <div class="card-body">
            <div class="row">
              <div class="col-md-8">
                <div class="chart-responsive">
                  <canvas id="pieChart" height="150"></canvas>
                </div>
                <!-- ./chart-responsive -->
              </div>
              <!-- /.col -->
              <div class="col-md-4">
                <ul class="chart-legend clearfix list-unstyled">
                  <li><i class="far fa-circle text-danger"></i> Joko Widodo</li>
                  <li><i class="far fa-circle text-success"></i> Prabowo</li>
                </ul>
              </div>
              <!-- /.col -->
            </div>
            <!-- /.row -->
          </div>
          <!-- /.card-body -->
          <div class="card-footer px-3">
            <div>
              <a href="#" class="nav-link">
                Jokowi
                <span class="float-right text-danger">
                  35%
                </span>
              </a>
            </div>
            <div>
              <a href="#" class="nav-link">
                Prabowo
                <span class="float-right text-success">
                  80%
                </span>
              </a>
            </div>
          </div>
          <!-- /.footer -->
        </div>
      </div>
    </div>
    <table id="data" class="table table-bordered table-striped">
      <thead>
        <tr>
          <th scope="col">Nama</th>
          <th scope="col">Waktu</th>
        </tr>
      </thead>
      <tbody>
        <% data.forEach(item=> { %>
          <tr>
            <td>
              <%= item.Pemilih.name %>
            </td>
            <td>
              <%= item.created_at %>
            </td>
          </tr>
          <% }); %>

      </tbody>
    </table>
  </div>

  <!-- jQuery -->
  <script src="plugins/jquery/jquery.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="plugins/sweetalert2/sweetalert2.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
      const socket = io();
      let playButtonClicked = false;

      const showPlayButton = () => {
        Swal.fire({
          title: 'Informasi',
          text: 'Voice akan otomatis diputar pada halaman ini',
          icon: 'info',
          allowOutsideClick: false,
          allowEscapeKey: false,
          allowEnterKey: false,
          confirmButtonText: 'Oke, Mengerti.',
          allowOutsideClick: false,
        }).then((result) => {
          if (result.isConfirmed) {
            playButtonClicked = true;
          }
        });
      };

      showPlayButton();

      socket.on('connect', () => {
        console.log('Connected to server');
      });

      socket.on('message', (message) => {
        const marquee = $('<marquee></marquee>').text(message).fadeIn('slow');

        $('#content').append(marquee);

        if (playButtonClicked) {
          const audio = $('<audio></audio>').attr('src', message.audio).appendTo('body');
          audio[0].play().catch((error) => {
            console.error('Error playing audio:', error);
          });
        } else {
          showPlayButton();
        }

        const newRow = ` 
                    <tr>
                        <td>${message.name}</td>
                        <td>${message.created_at}</td>
                    </tr>
                `;
        $('#data tbody').prepend(newRow);

         // Hapus data terakhir jika data pada table sudah lebih dari 15
      const rowCount = $('#data tbody tr').length;
      if (rowCount > 15) {
        $('#data tbody tr:last').remove();
      }
      });

      socket.on('disconnect', () => {
        console.log('Disconnected from server');
      });
    });
  </script>
  <script src="/plugins/chart.js/Chart.min.js"></script>
  <script>
    $(document).ready(function() {
      var pieChart;
      var pieChartCanvas = $('#pieChart').get(0).getContext('2d');
  
      function fetchData() {
        $.ajax({
          url: '/api/suara',
          method: 'GET',
          success: function(response) {
            var labels = response.map(function(kandidat) {
              return kandidat.name;
            });
            var data = response.map(function(kandidat) {
              return kandidat.votes;
            });
            var backgroundColors = ['#f56954', '#00a65a', '#f39c12', '#00c0ef', '#3c8dbc', '#d2d6de']; // Tambahkan lebih banyak warna jika kandidat lebih dari 2
  
            var pieData = {
              labels: labels,
              datasets: [
                {
                  data: data,
                  backgroundColor: backgroundColors.slice(0, labels.length)
                }
              ]
            };
  
            var pieOptions = {
              legend: {
                display: false
              }
            };
  
            if (pieChart) {
              // Jika grafik sudah ada, perbarui data dan panggil update
              pieChart.data = pieData;
              pieChart.update();
            } else {
              // Jika grafik belum ada, buat instance baru
              pieChart = new Chart(pieChartCanvas, {
                type: 'doughnut',
                data: pieData,
                options: pieOptions
              });
            }
  
            // Update chart legend and footer dynamically
            var legendHtml = '';
            var footerHtml = '';
            response.forEach(function(kandidat, index) {
              legendHtml += '<li><i class="far fa-circle" style="color:' + backgroundColors[index] + '"></i> ' + kandidat.name + '</li>';
              footerHtml += '<div><a href="#" class="nav-link">' + kandidat.name + '<span class="float-right" style="color:' + backgroundColors[index] + '">' + Math.round((kandidat.votes / data.reduce((a, b) => a + b)) * 100) + '%</span></a></div>';
            });
            $('.chart-legend').html(legendHtml);
            $('.card-footer').html(footerHtml);
          },
          error: function(error) {
            console.error('Error fetching data:', error);
          }
        });
      }
  
      fetchData();
      setInterval(fetchData, 60000); // Refresh setiap 60 detik
    });
  </script>
  
</body>

</html>
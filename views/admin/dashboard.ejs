<!-- Info boxes -->
<div class="row">
  <div class="col-12 col-sm-6 col-md-6">
    <div class="info-box">
      <span class="info-box-icon bg-info elevation-1"><i class="fas fa-user"></i></span>
      <div class="info-box-content">
        <span class="info-box-text">Kandidat</span>
        <span class="info-box-number">
          <%=jumlah_kandidat  %>
        </span>
      </div>
      <!-- /.info-box-content -->
    </div>
    <!-- /.info-box -->
  </div>
  <!-- /.col -->
  <div class="col-12 col-sm-6 col-md-6">
    <div class="info-box mb-3">
      <span class="info-box-icon bg-primary elevation-1"><i class="fas fa-vote-yea"></i></span>
      <div class="info-box-content">
        <span class="info-box-text">Pemilih</span>
        <span class="info-box-number"><%=jumlah_pemilih  %></span>
      </div>
      <!-- /.info-box-content -->
    </div>
    <!-- /.info-box -->
  </div>
  <!-- /.col -->

  <!-- fix for small devices only -->
  <div class="clearfix hidden-md-up"></div>
</div>
<div class="row">
  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Grafik Data Pemilu</h3>

        <div class="card-tools">
          <button type="button" class="btn btn-tool" data-card-widget="collapse">
            <i class="fas fa-minus"></i>
          </button>
          <button type="button" class="btn btn-tool" data-card-widget="remove">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <!-- /.card-header -->
      <div class="card-body">
        <div class="row">
          <div class="col-md-8">
            <div class="chart-responsive">
              <canvas id="pieChart" height="150"></canvas>
            </div>
            <!-- ./chart-responsive -->
          </div>
          <!-- /.col -->
          <div class="col-md-4">
            <ul class="chart-legend clearfix">
              <li><i class="far fa-circle text-danger"></i> Joko Widodo</li>
              <li><i class="far fa-circle text-success"></i> Prabowo</li>
            </ul>
          </div>
          <!-- /.col -->
        </div>
        <!-- /.row -->
      </div>
      <!-- /.card-body -->
      <div class="card-footer p-0">
        <ul class="nav nav-pills flex-column">
          <li class="nav-item">
            <a href="#" class="nav-link">
              Jokowi
              <span class="float-right text-danger">
                35%
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              Prabowo
              <span class="float-right text-success">
                80%
              </span>
            </a>
          </li>
        </ul>
      </div>
      <!-- /.footer -->
    </div>
  </div>
  <div class="col-md-8">
    
    <!-- TABLE: LATEST ORDERS -->
    <div class="card">
      <div class="card-header border-transparent">
        <h3 class="card-title">Latest Orders</h3>

        <div class="card-tools">
          <button type="button" class="btn btn-tool" data-card-widget="collapse">
            <i class="fas fa-minus"></i>
          </button>
          <button type="button" class="btn btn-tool" data-card-widget="remove">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <!-- /.card-header -->
      <div class="card-body p-0">
        <div class="table-responsive">
          <table id="data" class="table m-0">
            <thead>
              <tr>
                <th>Nama</th>
                <th>Waktu</th>
              </tr>
            </thead>
            <tbody>

              <% data.forEach(item=> { %>
                <tr>
                  <td><%= item.Pemilih.name %></td>
                  <td><%= item.created_at %></td>
                </tr>
                <% }); %>
            </tbody>
          </table>
        </div>
        <!-- /.table-responsive -->
      </div>
      <!-- /.card-body -->
      <!-- /.card-footer -->
    </div>
    <!-- /.card -->
  </div>
</div>

<!-- ChartJS -->
<script src="plugins/chart.js/Chart.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', (event) => {
    const socket = io();

    socket.on('connect', () => {
      console.log('Connected to server');
    });

    socket.on('message', (message) => {
      const newRow = ` 
                  <tr>
                      <td>${message.name}</td>
                      <td>${message.created_at}</td>
                  </tr>
              `;
      $('#data tbody').prepend(newRow);

      // Hapus data terakhir jika data pada table sudah lebih dari 11
      const rowCount = $('#data tbody tr').length;
      if (rowCount > 11) {
        $('#data tbody tr:last').remove();
      }
    });

    socket.on('disconnect', () => {
      console.log('Disconnected from server');
    });
  });
</script>
<script>
  $(document).ready(function() {
    var pieChart;
    var pieChartCanvas = $('#pieChart').get(0).getContext('2d');

    function fetchData() {
      $.ajax({
        url: '/api/suara',
        method: 'GET',
        success: function(response) {
          var labels = response.map(function(kandidat) {
            return kandidat.name;
          });
          var data = response.map(function(kandidat) {
            return kandidat.votes;
          });
          var backgroundColors = ['#f56954', '#00a65a', '#f39c12', '#00c0ef', '#3c8dbc', '#d2d6de']; // Tambahkan lebih banyak warna jika kandidat lebih dari 2

          var pieData = {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: backgroundColors.slice(0, labels.length)
              }
            ]
          };

          var pieOptions = {
            legend: {
              display: false
            }
          };

          if (pieChart) {
            // Jika grafik sudah ada, perbarui data dan panggil update
            pieChart.data = pieData;
            pieChart.update();
          } else {
            // Jika grafik belum ada, buat instance baru
            pieChart = new Chart(pieChartCanvas, {
              type: 'doughnut',
              data: pieData,
              options: pieOptions
            });
          }

          // Update chart legend and footer dynamically
          var legendHtml = '';
          var footerHtml = '';
          response.forEach(function(kandidat, index) {
            legendHtml += '<li><i class="far fa-circle" style="color:' + backgroundColors[index] + '"></i> ' + kandidat.name + '</li>';
            footerHtml += '<div><a href="#" class="nav-link">' + kandidat.name + '<span class="float-right" style="color:' + backgroundColors[index] + '">' + Math.round((kandidat.votes / data.reduce((a, b) => a + b)) * 100) + '%</span></a></div>';
          });
          $('.chart-legend').html(legendHtml);
          $('.card-footer').html(footerHtml);
        },
        error: function(error) {
          console.error('Error fetching data:', error);
        }
      });
    }

    fetchData();
    setInterval(fetchData, 10000); // Refresh setiap 10 detik
  });
</script>